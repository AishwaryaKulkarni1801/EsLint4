name: Deploy Angular App to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“‚ Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run Jest tests with coverage
        id: test-coverage
        run: |
          echo "Running Jest tests with coverage..."
          npm run test -- --coverage --watchAll=false --verbose
          
          # Check if tests passed
          if [ $? -ne 0 ]; then
            echo "::error::Test suite failed"
            echo "test_result=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Parse coverage from Jest output
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -p "
              const fs = require('fs');
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              Math.round(coverage.total.lines.pct);
            ")
            echo "Total coverage: ${COVERAGE}%"
            echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
            
            if [ $COVERAGE -lt 80 ]; then
              echo "::error::Code coverage below 80% (Actual: ${COVERAGE}%)"
              echo "test_result=coverage_failed" >> $GITHUB_OUTPUT
              echo "coverage_value=${COVERAGE}" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "âœ… Coverage check passed: ${COVERAGE}% >= 80%"
              echo "test_result=passed" >> $GITHUB_OUTPUT
              echo "coverage_value=${COVERAGE}" >> $GITHUB_OUTPUT
            fi
          else
            echo "::error::Coverage file not found"
            echo "test_result=coverage_file_missing" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ§¹ Run ESLint validation
        id: lint-check
        run: |
          echo "Running ESLint validation..."
          npm run lint
          
          if [ $? -ne 0 ]; then
            echo "::error::ESLint validation failed"
            echo "lint_result=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… ESLint validation passed"
            echo "lint_result=passed" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ—ï¸ Build Angular project
        id: build-project
        run: |
          echo "Building Angular project..."
          npm run build -- --base-href '/EsLint4/'
          
          if [ $? -ne 0 ]; then
            echo "::error::Build failed"
            echo "build_result=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… Build completed successfully"
            echo "build_result=success" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“‹ Copy index.html to 404.html (SPA routing fix)
        run: |
          if [ -f "dist/es-lint4/index.html" ]; then
            cp dist/es-lint4/index.html dist/es-lint4/404.html
            echo "âœ… Created 404.html for SPA routing"
          else
            echo "::warning::index.html not found in build output"
          fi

      - name: âš™ï¸ Configure GitHub Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist/es-lint4

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify:
    runs-on: ubuntu-latest
    needs: build-test-deploy
    if: always()
    steps:
      - name: ğŸ“¢ Deployment Notification
        run: |
          if [[ "${{ needs.build-test-deploy.result }}" == "success" ]]; then
            echo "âœ… Deployment succeeded! ğŸ‰"
            echo "ğŸ“ Check your site at: https://AishwaryaKulkarni1801.github.io/EsLint4/"
            echo ""
            echo "=== Deployment Summary ==="
            echo "âœ… Jest Tests: Passed"
            echo "âœ… Code Coverage: â‰¥ 80%"
            echo "âœ… ESLint Validation: Passed"
            echo "âœ… Angular Build: Success"
            echo "âœ… GitHub Pages: Deployed"
            echo "=========================="
          else
            echo "âŒ Deployment failed!"
            echo ""
            echo "=== Failure Analysis ==="
            
            # Check specific failure reasons from job outputs
            TEST_RESULT="${{ needs.build-test-deploy.outputs.test_result || 'unknown' }}"
            LINT_RESULT="${{ needs.build-test-deploy.outputs.lint_result || 'unknown' }}"
            BUILD_RESULT="${{ needs.build-test-deploy.outputs.build_result || 'unknown' }}"
            COVERAGE_VALUE="${{ needs.build-test-deploy.outputs.coverage_value || 'unknown' }}"
            
            if [[ "$TEST_RESULT" == "failed" ]]; then
              echo "âŒ Deployment stopped: Test suite failed"
              echo "   â†’ Check Jest test output for specific failures"
            elif [[ "$TEST_RESULT" == "coverage_failed" ]]; then
              echo "âŒ Deployment stopped: Code coverage below 80% (Actual: ${COVERAGE_VALUE}%)"
              echo "   â†’ Add more unit tests to increase coverage"
            elif [[ "$TEST_RESULT" == "coverage_file_missing" ]]; then
              echo "âŒ Deployment stopped: Coverage file not generated"
              echo "   â†’ Check Jest configuration for coverage output"
            elif [[ "$LINT_RESULT" == "failed" ]]; then
              echo "âŒ Deployment stopped: ESLint validation failed"
              echo "   â†’ Fix linting errors before deployment"
            elif [[ "$BUILD_RESULT" == "failed" ]]; then
              echo "âŒ Deployment stopped: Angular build failed"
              echo "   â†’ Check build output for compilation errors"
            else
              echo "âŒ Deployment stopped: Unknown error occurred"
              echo "   â†’ Check previous step logs for details"
            fi
            
            echo ""
            echo "ğŸ” Troubleshooting Tips:"
            echo "1. Run 'npm test' locally to check test coverage"
            echo "2. Run 'npm run lint' locally to check ESLint issues"
            echo "3. Run 'npm run build' locally to verify build process"
            echo "=========================="
          fi
