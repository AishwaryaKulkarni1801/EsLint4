name: Deploy Angular App to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    outputs:
      install_result: ${{ steps.npm-install.outputs.install_result }}
      install_method: ${{ steps.npm-install.outputs.install_method }}
      test_result: ${{ steps.test-coverage.outputs.test_result }}
      coverage_value: ${{ steps.test-coverage.outputs.coverage_value }}
      lint_result: ${{ steps.lint-check.outputs.lint_result }}
      build_result: ${{ steps.build-project.outputs.build_result }}
      build_method: ${{ steps.build-project.outputs.build_method }}
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üìÇ Cache node_modules and .npm
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: üßπ Clean npm cache
        run: |
          echo "Cleaning npm cache to prevent conflicts..."
          npm cache clean --force

      - name: üì• Install dependencies with conflict resolution
        id: npm-install
        run: |
          echo "Attempting npm ci with legacy peer deps..."
          
          # First attempt: npm ci with legacy-peer-deps
          if npm ci --legacy-peer-deps; then
            echo "‚úÖ npm ci succeeded with legacy-peer-deps"
            echo "install_method=npm-ci-legacy" >> $GITHUB_OUTPUT
            echo "install_result=success" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è npm ci failed, attempting fallback to npm install..."
            
            # Fallback: npm install with legacy-peer-deps
            if npm install --legacy-peer-deps; then
              echo "‚úÖ npm install succeeded with legacy-peer-deps"
              echo "install_method=npm-install-legacy" >> $GITHUB_OUTPUT
              echo "install_result=success" >> $GITHUB_OUTPUT
            else
              echo "::error::Both npm ci and npm install failed"
              echo "install_method=failed" >> $GITHUB_OUTPUT
              echo "install_result=failed" >> $GITHUB_OUTPUT
              
              echo ""
              echo "=== Dependency Installation Troubleshooting ==="
              echo "1. Check package.json for version conflicts"
              echo "2. Verify package-lock.json is compatible"
              echo "3. Review peer dependency warnings above"
              echo "================================================"
              exit 1
            fi
          fi

      - name: üß™ Run Jest tests with coverage
        id: test-coverage
        run: |
          echo "Running Jest tests with coverage..."
          npm run test -- --coverage --watchAll=false --verbose
          
          # Check if tests passed
          if [ $? -ne 0 ]; then
            echo "::error::Test suite failed"
            echo "test_result=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Parse coverage from Jest output
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -p "
              const fs = require('fs');
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              Math.round(coverage.total.lines.pct);
            ")
            echo "Total coverage: ${COVERAGE}%"
            echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
            
            if [ $COVERAGE -lt 80 ]; then
              echo "::error::Code coverage below 80% (Actual: ${COVERAGE}%)"
              echo "test_result=coverage_failed" >> $GITHUB_OUTPUT
              echo "coverage_value=${COVERAGE}" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "‚úÖ Coverage check passed: ${COVERAGE}% >= 80%"
              echo "test_result=passed" >> $GITHUB_OUTPUT
              echo "coverage_value=${COVERAGE}" >> $GITHUB_OUTPUT
            fi
          else
            echo "::error::Coverage file not found"
            echo "test_result=coverage_file_missing" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: üßπ Run ESLint validation
        id: lint-check
        run: |
          echo "Running ESLint validation..."
          npm run lint
          
          if [ $? -ne 0 ]; then
            echo "::error::ESLint validation failed"
            echo "lint_result=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "‚úÖ ESLint validation passed"
            echo "lint_result=passed" >> $GITHUB_OUTPUT
          fi

      - name: üèóÔ∏è Build Angular project
        id: build-project
        run: |
          echo "Building Angular project..."
          
          # First attempt: regular build
          if npm run build -- --base-href '/EsLint4/'; then
            echo "‚úÖ Build completed successfully"
            echo "build_result=success" >> $GITHUB_OUTPUT
            echo "build_method=standard" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Standard build failed, attempting rebuild after cache clean..."
            
            # Clear any potential build cache and retry
            rm -rf dist/ node_modules/.cache/ .angular/
            
            if npm run build -- --base-href '/EsLint4/'; then
              echo "‚úÖ Build completed successfully after cache clean"
              echo "build_result=success" >> $GITHUB_OUTPUT
              echo "build_method=retry-after-clean" >> $GITHUB_OUTPUT
            else
              echo "::error::Build failed after retry"
              echo "build_result=failed" >> $GITHUB_OUTPUT
              echo "build_method=failed" >> $GITHUB_OUTPUT
              
              echo ""
              echo "=== Build Failure Troubleshooting ==="
              echo "1. Check TypeScript compilation errors above"
              echo "2. Verify angular.json configuration"
              echo "3. Check for missing dependencies"
              echo "4. Review environment-specific build settings"
              echo "====================================="
              exit 1
            fi
          fi

      - name: üìã Copy index.html to 404.html (SPA routing fix)
        run: |
          if [ -f "dist/es-lint4/index.html" ]; then
            cp dist/es-lint4/index.html dist/es-lint4/404.html
            echo "‚úÖ Created 404.html for SPA routing"
          else
            echo "::warning::index.html not found in build output"
          fi

      - name: ‚öôÔ∏è Configure GitHub Pages
        uses: actions/configure-pages@v4

      - name: üì§ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist/es-lint4

      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify:
    runs-on: ubuntu-latest
    needs: build-test-deploy
    if: always()
    steps:
      - name: üì¢ Deployment Notification
        run: |
          if [[ "${{ needs.build-test-deploy.result }}" == "success" ]]; then
            echo "‚úÖ Deployment succeeded! üéâ"
            echo "üìç Check your site at: https://AishwaryaKulkarni1801.github.io/EsLint4/"
            echo ""
            echo "=== Deployment Summary ==="
            echo "‚úÖ Dependencies: Installed (${{ needs.build-test-deploy.outputs.install_method }})"
            echo "‚úÖ Jest Tests: Passed"
            echo "‚úÖ Code Coverage: ‚â• 80% (${{ needs.build-test-deploy.outputs.coverage_value }}%)"
            echo "‚úÖ ESLint Validation: Passed"
            echo "‚úÖ Angular Build: Success (${{ needs.build-test-deploy.outputs.build_method }})"
            echo "‚úÖ GitHub Pages: Deployed"
            echo "=========================="
          else
            echo "‚ùå Deployment failed!"
            echo ""
            echo "=== Failure Analysis ==="
            
            # Check specific failure reasons from job outputs
            INSTALL_RESULT="${{ needs.build-test-deploy.outputs.install_result || 'unknown' }}"
            INSTALL_METHOD="${{ needs.build-test-deploy.outputs.install_method || 'unknown' }}"
            TEST_RESULT="${{ needs.build-test-deploy.outputs.test_result || 'unknown' }}"
            LINT_RESULT="${{ needs.build-test-deploy.outputs.lint_result || 'unknown' }}"
            BUILD_RESULT="${{ needs.build-test-deploy.outputs.build_result || 'unknown' }}"
            BUILD_METHOD="${{ needs.build-test-deploy.outputs.build_method || 'unknown' }}"
            COVERAGE_VALUE="${{ needs.build-test-deploy.outputs.coverage_value || 'unknown' }}"
            
            if [[ "$INSTALL_RESULT" == "failed" ]]; then
              echo "‚ùå Deployment stopped: npm dependency conflict"
              echo "   ‚Üí Method attempted: ${INSTALL_METHOD}"
              echo "   ‚Üí Check for ESLint/TypeScript version incompatibilities"
              echo "   ‚Üí Review package.json peer dependency requirements"
            elif [[ "$TEST_RESULT" == "failed" ]]; then
              echo "‚ùå Deployment stopped: Test suite failed"
              echo "   ‚Üí Check Jest test output for specific failures"
            elif [[ "$TEST_RESULT" == "coverage_failed" ]]; then
              echo "‚ùå Deployment stopped: Code coverage below 80% (Actual: ${COVERAGE_VALUE}%)"
              echo "   ‚Üí Add more unit tests to increase coverage"
            elif [[ "$TEST_RESULT" == "coverage_file_missing" ]]; then
              echo "‚ùå Deployment stopped: Coverage file not generated"
              echo "   ‚Üí Check Jest configuration for coverage output"
            elif [[ "$LINT_RESULT" == "failed" ]]; then
              echo "‚ùå Deployment stopped: ESLint validation failed"
              echo "   ‚Üí Fix linting errors before deployment"
            elif [[ "$BUILD_RESULT" == "failed" ]]; then
              echo "‚ùå Deployment stopped: Angular build failed"
              echo "   ‚Üí Build method: ${BUILD_METHOD}"
              echo "   ‚Üí Check TypeScript compilation errors"
              echo "   ‚Üí Verify Angular configuration"
            else
              echo "‚ùå Deployment stopped: Unknown error occurred"
              echo "   ‚Üí Check previous step logs for details"
            fi
            
            echo ""
            echo "üîç npm-related Troubleshooting Tips:"
            echo "1. Run 'npm cache clean --force' locally"
            echo "2. Run 'npm install --legacy-peer-deps' locally"
            echo "3. Verify your package-lock.json is up to date"
            echo "4. Check for conflicting peer dependencies"
            echo ""
            echo "üîç General Troubleshooting Tips:"
            echo "1. Run 'npm test' locally to check test coverage"
            echo "2. Run 'npm run lint' locally to check ESLint issues"
            echo "3. Run 'npm run build' locally to verify build process"
            echo "=========================="
          fi
